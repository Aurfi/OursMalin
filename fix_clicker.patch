From 0c36da541fa399fed27aed937e5957419bc859bc Mon Sep 17 00:00:00 2001
From: ChatGPT <chatgpt@example.com>
Date: Thu, 7 Aug 2025 04:29:03 -0700
Subject: [PATCH] Fix skin popup auto display and ensure purchase buttons
 update

---
 courgette/js/main.js | 30 +++++++++++++++++++++++++-----
 1 file changed, 25 insertions(+), 5 deletions(-)

diff --git a/courgette/js/main.js b/courgette/js/main.js
index a81c005..10f060c 100644
--- a/courgette/js/main.js
+++ b/courgette/js/main.js
@@ -2530,6 +2530,19 @@ function updateStats() {
   updateProgressBar();
   // Vérifier les achievements après la mise à jour des stats
   checkAchievements();
+
+  // En fin de mise à jour des statistiques, mettre à jour l'état des boutons
+  // d'améliorations. Ceci permet de rafraîchir l'affichage des boutons
+  // d'achat dès que le score change (par exemple après un clic ou une
+  // production automatique) et d'éviter qu'un bouton reste activé alors que
+  // le joueur ne peut plus se permettre l'achat. Sans cet appel, les boutons
+  // pouvaient sembler de nouveau verts malgré un solde insuffisant car
+  // updateUpgradeButtons() n'était invoqué qu'à des moments précis (au
+  // rendu initial et après l'achat). De même, on met à jour les boutons
+  // d'améliorations globales pour qu'ils reflètent correctement l'état
+  // d'accessibilité en fonction des fonds et des conditions de déblocage.
+  if (typeof updateUpgradeButtons === 'function') updateUpgradeButtons();
+  if (typeof updateGlobalUpgradeButtons === 'function') updateGlobalUpgradeButtons();
 }
 
 // -----------------------------------------------------------------------------
@@ -3176,13 +3189,20 @@ function updateSkinSettingVisibility() {
 
 // Ouvrir la pop-up de paiement pour le skin Aubergine.  Cette fonction
 // affiche un overlay sombre et propose deux boutons : PayPal et Retour.
-// Masquer la pop‑up promotionnelle au démarrage, puis ne l'afficher que si
-// une condition explicite le demande.
+// Sur certaines versions du jeu, une variable interne pouvait être modifiée
+// accidentellement provoquant l'affichage immédiat de la pop‑up à
+// l'ouverture de la page. Pour prévenir tout affichage non désiré,
+// on force désormais le masquage de la pop‑up à l'initialisation.
+// La pop‑up ne s'affichera ensuite que suite à une interaction utilisateur via
+// openSkinPopup().
 window.addEventListener('DOMContentLoaded', () => {
   const popup = document.getElementById('skin-popup');
-  const shouldShowPopup = false; // changer à true pour l'afficher automatiquement
-  if (popup && shouldShowPopup) {
-    popup.removeAttribute('hidden');
+  if (popup) {
+    // Le fait de définir l'attribut hidden garantit un affichage masqué.
+    // Même si le code HTML initial ne comporte pas l'attribut hidden ou qu'un
+    // autre script l'a retiré, cette instruction s'assure qu'à l'initialisation
+    // le composant reste invisible tant qu'un utilisateur ne le demande pas.
+    popup.setAttribute('hidden', '');
   }
 });
 
-- 
2.39.5

